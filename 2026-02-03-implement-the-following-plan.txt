
 â–â–›â–ˆâ–ˆâ–ˆâ–œâ–Œ   Claude Code v2.1.27
â–â–œâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–›â–˜  Sonnet 4.5 Â· Claude Pro
  â–˜â–˜ â–â–    ~/dev/Rapporte

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ Plan to implement                                                            â”‚
â”‚                                                                              â”‚
â”‚ Implementierungsplan: Swiss QR Bill Rechnungsfunktion                        â”‚
â”‚                                                                              â”‚
â”‚ Ãœbersicht                                                                    â”‚
â”‚                                                                              â”‚
â”‚ Implementierung einer Rechnungserstellungs-Funktion mit Swiss QR Bill        â”‚
â”‚ (QR-Rechnung nach ISO 20022) fÃ¼r einzelne Rapporte. Verwendet qrbill         â”‚
â”‚ Bibliothek mit ReportLab-Integration.                                        â”‚
â”‚                                                                              â”‚
â”‚ Entscheidungen (bestÃ¤tigt)                                                   â”‚
â”‚                                                                              â”‚
â”‚ - Rechnungsnummer: RE-YYYYMMDD-XXXXX (z.B. RE-20260203-00001)                â”‚
â”‚ - Umfang: Einzel-Rapport-Rechnungen (MVP), Multi-Rapport spÃ¤ter              â”‚
â”‚ - Tracking: Neue rechnungen Tabelle fÃ¼r Historie                             â”‚
â”‚ - MwSt: Keine MwSt-Zeile auf Rechnung                                        â”‚
â”‚ - QR-Referenz: Ohne QRR, Rechnungsnummer in Mitteilungsfeld                  â”‚
â”‚ - Adressen: Separate Felder (strasse, hausnummer, plz, stadt) statt Freitext â”‚
â”‚ - Rapport-Text: thema-Feld wird auf Rechnung als Beschreibung angezeigt      â”‚
â”‚                                                                              â”‚
â”‚ Kritische Dateien                                                            â”‚
â”‚                                                                              â”‚
â”‚ 1. app/database.py - Neue rechnungen Tabelle hinzufÃ¼gen                      â”‚
â”‚ 2. requirements.txt - Dependencies: qrbill==1.2.0, svglib==1.5.1             â”‚
â”‚ 3. docker-compose.yml - PAYEE_* Environment-Variablen                        â”‚
â”‚ 4. app/main.py - QR-Bill-Logik, Routen, PDF-Generierung                      â”‚
â”‚ 5. app/templates/index.html - "Rechnung" Button bei jedem Rapport            â”‚
â”‚                                                                              â”‚
â”‚ Implementierungsschritte                                                     â”‚
â”‚                                                                              â”‚
â”‚ 0. WICHTIG: Datenbank-Backup erstellen                                       â”‚
â”‚                                                                              â”‚
â”‚ LIVE-DATEN! Backup ZUERST erstellen!                                         â”‚
â”‚                                                                              â”‚
â”‚ # Backup erstellen (Datum im Dateinamen)                                     â”‚
â”‚ cp data/rapporte.db data/rapporte_backup_$(date +%Y%m%d_%H%M%S).db           â”‚
â”‚                                                                              â”‚
â”‚ # Oder aus Docker-Container:                                                 â”‚
â”‚ docker cp rapporte-web-1:/app/data/rapporte.db ./rapporte_backup_$(date      â”‚
â”‚ +%Y%m%d_%H%M%S).db                                                           â”‚
â”‚                                                                              â”‚
â”‚ # Backup verifizieren                                                        â”‚
â”‚ ls -lh data/rapporte_backup_*.db                                             â”‚
â”‚ # ODER                                                                       â”‚
â”‚ ls -lh rapporte_backup_*.db                                                  â”‚
â”‚                                                                              â”‚
â”‚ Bei Problemen Rollback:                                                      â”‚
â”‚ # Backup wiederherstellen                                                    â”‚
â”‚ cp data/rapporte_backup_YYYYMMDD_HHMMSS.db data/rapporte.db                  â”‚
â”‚ docker-compose restart                                                       â”‚
â”‚                                                                              â”‚
â”‚ 1. Dependencies hinzufÃ¼gen                                                   â”‚
â”‚                                                                              â”‚
â”‚ Datei: requirements.txt                                                      â”‚
â”‚                                                                              â”‚
â”‚ qrbill==1.2.0                                                                â”‚
â”‚ svglib==1.5.1                                                                â”‚
â”‚                                                                              â”‚
â”‚ 2. Environment-Variablen konfigurieren                                       â”‚
â”‚                                                                              â”‚
â”‚ Datei: docker-compose.yml                                                    â”‚
â”‚                                                                              â”‚
â”‚ Neue Environment-Variablen hinzufÃ¼gen:                                       â”‚
â”‚                                                                              â”‚
â”‚ - PAYEE_LEGAL_NAME=Ihr Name oder Firmenname                                  â”‚
â”‚ - PAYEE_IBAN=CH5800791123000889012  # Ihre QR-IBAN                           â”‚
â”‚ - PAYEE_BANK=Name der Bank                                                   â”‚
â”‚ - PAYEE_BIC=POFICHBEXXX                                                      â”‚
â”‚ - PAYEE_DISPLAY_NAME=Ihr Anzeigename                                         â”‚
â”‚ - PAYEE_ADDRESS_LINE1=Strasse und Hausnummer                                 â”‚
â”‚ - PAYEE_ADDRESS_LINE2=PLZ und Ort                                            â”‚
â”‚ - PAYEE_COUNTRY=CH                                                           â”‚
â”‚                                                                              â”‚
â”‚ Wichtig: Echte IBAN aus Dietipi-App Ã¼bernehmen (~/dev/Dietipi-App/.env)      â”‚
â”‚                                                                              â”‚
â”‚ 3. Datenbank-Schema erweitern                                                â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/database.py                                                       â”‚
â”‚                                                                              â”‚
â”‚ 3.1 Kunden-Tabelle: Adressfelder hinzufÃ¼gen                                  â”‚
â”‚                                                                              â”‚
â”‚ Ersetze das kunden CREATE TABLE Statement:                                   â”‚
â”‚                                                                              â”‚
â”‚ # Kunden Tabelle                                                             â”‚
â”‚ db.execute('''                                                               â”‚
â”‚     CREATE TABLE IF NOT EXISTS kunden (                                      â”‚
â”‚         id INTEGER PRIMARY KEY AUTOINCREMENT,                                â”‚
â”‚         name TEXT NOT NULL,                                                  â”‚
â”‚         email TEXT,                                                          â”‚
â”‚         telefon TEXT,                                                        â”‚
â”‚         adresse TEXT,                                                        â”‚
â”‚         strasse TEXT,                                                        â”‚
â”‚         hausnummer TEXT,                                                     â”‚
â”‚         plz TEXT,                                                            â”‚
â”‚         stadt TEXT,                                                          â”‚
â”‚         it_infrastruktur TEXT,                                               â”‚
â”‚         stundensatz REAL DEFAULT 120.0,                                      â”‚
â”‚         erstellt_am TIMESTAMP DEFAULT CURRENT_TIMESTAMP                      â”‚
â”‚     )                                                                        â”‚
â”‚ ''')                                                                         â”‚
â”‚                                                                              â”‚
â”‚ Hinweis: adresse Feld bleibt als Fallback bestehen fÃ¼r alte EintrÃ¤ge.        â”‚
â”‚                                                                              â”‚
â”‚ 3.2 Neue Tabelle: rechnungen                                                 â”‚
â”‚                                                                              â”‚
â”‚ Nach den bestehenden Tabellen hinzufÃ¼gen:                                    â”‚
â”‚                                                                              â”‚
â”‚ # Rechnungen Tabelle                                                         â”‚
â”‚ db.execute('''                                                               â”‚
â”‚     CREATE TABLE IF NOT EXISTS rechnungen (                                  â”‚
â”‚         id INTEGER PRIMARY KEY AUTOINCREMENT,                                â”‚
â”‚         rechnungs_nummer TEXT UNIQUE NOT NULL,                               â”‚
â”‚         kunde_id INTEGER NOT NULL,                                           â”‚
â”‚         erstellt_am TIMESTAMP DEFAULT CURRENT_TIMESTAMP,                     â”‚
â”‚         betrag REAL NOT NULL,                                                â”‚
â”‚         rapport_ids TEXT NOT NULL,                                           â”‚
â”‚         FOREIGN KEY (kunde_id) REFERENCES kunden (id)                        â”‚
â”‚     )                                                                        â”‚
â”‚ ''')                                                                         â”‚
â”‚                                                                              â”‚
â”‚ 3.3 Datenmigration: Bestehende Adressen aufteilen                            â”‚
â”‚                                                                              â”‚
â”‚ Neue Datei erstellen: migrate_adressen.py im Projekt-Root                    â”‚
â”‚                                                                              â”‚
â”‚ #!/usr/bin/env python3                                                       â”‚
â”‚ """                                                                          â”‚
â”‚ Migriert bestehende Adressen (Freitext) in separate Felder.                  â”‚
â”‚ Einmalig nach Schema-Update ausfÃ¼hren!                                       â”‚
â”‚ """                                                                          â”‚
â”‚ import sqlite3                                                               â”‚
â”‚ import re                                                                    â”‚
â”‚                                                                              â”‚
â”‚ def parse_adresse(adresse_text):                                             â”‚
â”‚     """Versucht Adresse in Komponenten zu zerlegen"""                        â”‚
â”‚     if not adresse_text:                                                     â”‚
â”‚         return None, None, None, None                                        â”‚
â”‚                                                                              â”‚
â”‚     lines = [l.strip() for l in adresse_text.strip().split('\n') if          â”‚
â”‚ l.strip()]                                                                   â”‚
â”‚                                                                              â”‚
â”‚     strasse = None                                                           â”‚
â”‚     hausnummer = None                                                        â”‚
â”‚     plz = None                                                               â”‚
â”‚     stadt = None                                                             â”‚
â”‚                                                                              â”‚
â”‚     # Erste Zeile: Strasse + Hausnummer                                      â”‚
â”‚     if len(lines) >= 1:                                                      â”‚
â”‚         # Trenne Hausnummer am Ende ab (Zahlen oder Zahlen+Buchstabe)        â”‚
â”‚         match = re.match(r'^(.+?)\s+(\d+[a-zA-Z]?)$', lines[0])              â”‚
â”‚         if match:                                                            â”‚
â”‚             strasse = match.group(1).strip()                                 â”‚
â”‚             hausnummer = match.group(2).strip()                              â”‚
â”‚         else:                                                                â”‚
â”‚             strasse = lines[0]                                               â”‚
â”‚                                                                              â”‚
â”‚     # Letzte Zeile: PLZ + Stadt                                              â”‚
â”‚     if len(lines) >= 2:                                                      â”‚
â”‚         last_line = lines[-1]                                                â”‚
â”‚         match = re.match(r'^(\d{4})\s+(.+)$', last_line)                     â”‚
â”‚         if match:                                                            â”‚
â”‚             plz = match.group(1)                                             â”‚
â”‚             stadt = match.group(2).strip()                                   â”‚
â”‚                                                                              â”‚
â”‚     return strasse, hausnummer, plz, stadt                                   â”‚
â”‚                                                                              â”‚
â”‚ def migrate_addresses(db_path='data/rapporte.db'):                           â”‚
â”‚     """FÃ¼hrt Migration durch"""                                              â”‚
â”‚     conn = sqlite3.connect(db_path)                                          â”‚
â”‚     conn.row_factory = sqlite3.Row                                           â”‚
â”‚     cursor = conn.cursor()                                                   â”‚
â”‚                                                                              â”‚
â”‚     # Hole alle Kunden mit adresse                                           â”‚
â”‚     kunden = cursor.execute('SELECT id, name, adresse FROM                   â”‚
â”‚ kunden').fetchall()                                                          â”‚
â”‚                                                                              â”‚
â”‚     print(f"Migriere {len(kunden)} Kunden...")                               â”‚
â”‚                                                                              â”‚
â”‚     for kunde in kunden:                                                     â”‚
â”‚         if not kunde['adresse']:                                             â”‚
â”‚             print(f"  Kunde {kunde['id']} ({kunde['name']}): Keine Adresse") â”‚
â”‚             continue                                                         â”‚
â”‚                                                                              â”‚
â”‚         strasse, hausnr, plz, stadt = parse_adresse(kunde['adresse'])        â”‚
â”‚                                                                              â”‚
â”‚         print(f"  Kunde {kunde['id']} ({kunde['name']}):")                   â”‚
â”‚         print(f"    Original: {kunde['adresse']}")                           â”‚
â”‚         print(f"    Geparst: {strasse} {hausnr}, {plz} {stadt}")             â”‚
â”‚                                                                              â”‚
â”‚         # Update                                                             â”‚
â”‚         cursor.execute('''                                                   â”‚
â”‚             UPDATE kunden                                                    â”‚
â”‚             SET strasse=?, hausnummer=?, plz=?, stadt=?                      â”‚
â”‚             WHERE id=?                                                       â”‚
â”‚         ''', (strasse, hausnr, plz, stadt, kunde['id']))                     â”‚
â”‚                                                                              â”‚
â”‚     conn.commit()                                                            â”‚
â”‚     conn.close()                                                             â”‚
â”‚     print("\nMigration abgeschlossen!")                                      â”‚
â”‚                                                                              â”‚
â”‚ if __name__ == '__main__':                                                   â”‚
â”‚     migrate_addresses()                                                      â”‚
â”‚                                                                              â”‚
â”‚ Nach Schema-Update ausfÃ¼hren:                                                â”‚
â”‚ python3 migrate_adressen.py                                                  â”‚
â”‚                                                                              â”‚
â”‚ 4. Payment-Konfiguration in app/main.py                                      â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/main.py                                                           â”‚
â”‚                                                                              â”‚
â”‚ Nach Zeile 26 (users dict) hinzufÃ¼gen:                                       â”‚
â”‚                                                                              â”‚
â”‚ # Payment/Rechnungs-Konfiguration                                            â”‚
â”‚ PAYEE_CONFIG = {                                                             â”‚
â”‚     'legal_name': os.environ.get('PAYEE_LEGAL_NAME', ''),                    â”‚
â”‚     'iban': os.environ.get('PAYEE_IBAN', ''),                                â”‚
â”‚     'bank': os.environ.get('PAYEE_BANK', ''),                                â”‚
â”‚     'bic': os.environ.get('PAYEE_BIC', ''),                                  â”‚
â”‚     'display_name': os.environ.get('PAYEE_DISPLAY_NAME', ''),                â”‚
â”‚     'address_line1': os.environ.get('PAYEE_ADDRESS_LINE1', ''),              â”‚
â”‚     'address_line2': os.environ.get('PAYEE_ADDRESS_LINE2', ''),              â”‚
â”‚     'country': os.environ.get('PAYEE_COUNTRY', 'CH')                         â”‚
â”‚ }                                                                            â”‚
â”‚                                                                              â”‚
â”‚ 5. Imports erweitern                                                         â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/main.py (Zeile 1-13)                                              â”‚
â”‚                                                                              â”‚
â”‚ HinzufÃ¼gen:                                                                  â”‚
â”‚                                                                              â”‚
â”‚ from qrbill import QRBill                                                    â”‚
â”‚ from svglib.svglib import svg2rlg                                            â”‚
â”‚                                                                              â”‚
â”‚ 6. Helper-Funktionen implementieren                                          â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/main.py (nach format_date_ch Funktion)                            â”‚
â”‚                                                                              â”‚
â”‚ 6.1 Rechnungsnummer generieren                                               â”‚
â”‚                                                                              â”‚
â”‚ def generiere_rechnungsnummer():                                             â”‚
â”‚     """Generiert eindeutige Rechnungsnummer im Format RE-YYYYMMDD-XXXXX"""   â”‚
â”‚     db = get_db()                                                            â”‚
â”‚     today = datetime.now().strftime("%Y%m%d")                                â”‚
â”‚                                                                              â”‚
â”‚     # ZÃ¤hle Rechnungen von heute                                             â”‚
â”‚     count = db.execute(                                                      â”‚
â”‚         "SELECT COUNT(*) as cnt FROM rechnungen WHERE rechnungs_nummer LIKE  â”‚
â”‚ ?",                                                                          â”‚
â”‚         (f"RE-{today}-%",)                                                   â”‚
â”‚     ).fetchone()['cnt']                                                      â”‚
â”‚                                                                              â”‚
â”‚     return f"RE-{today}-{count+1:05d}"                                       â”‚
â”‚                                                                              â”‚
â”‚ 6.2 QR-Rechnung generieren                                                   â”‚
â”‚                                                                              â”‚
â”‚ def generiere_qr_rechnung(betrag, kunde, rechnungs_nummer):                  â”‚
â”‚     """Generiert Swiss QR Bill als ReportLab Drawing"""                      â”‚
â”‚                                                                              â”‚
â”‚     if not PAYEE_CONFIG['iban']:                                             â”‚
â”‚         raise ValueError("PAYEE_IBAN nicht konfiguriert")                    â”‚
â”‚                                                                              â”‚
â”‚     # Nutze strukturierte Adressfelder (neue Struktur)                       â”‚
â”‚     kunde_strasse = kunde.get('strasse', '') or ''                           â”‚
â”‚     kunde_hausnummer = kunde.get('hausnummer', '') or ''                     â”‚
â”‚     kunde_plz = kunde.get('plz', '') or ''                                   â”‚
â”‚     kunde_stadt = kunde.get('stadt', '') or ''                               â”‚
â”‚                                                                              â”‚
â”‚     # VollstÃ¤ndige Strasse fÃ¼r QR Bill                                       â”‚
â”‚     kunde_strasse_komplett = f"{kunde_strasse} {kunde_hausnummer}".strip()   â”‚
â”‚ if kunde_strasse else ''                                                     â”‚
â”‚                                                                              â”‚
â”‚     # Creditor (Rechnungssteller)                                            â”‚
â”‚     creditor_plz_ort = PAYEE_CONFIG['address_line2'].split(maxsplit=1)       â”‚
â”‚     creditor_data = {                                                        â”‚
â”‚         'name': PAYEE_CONFIG['legal_name'],                                  â”‚
â”‚         'pcode': creditor_plz_ort[0] if len(creditor_plz_ort) > 0 else       â”‚
â”‚ '8000',                                                                      â”‚
â”‚         'city': creditor_plz_ort[1] if len(creditor_plz_ort) > 1 else        â”‚
â”‚ 'ZÃ¼rich',                                                                    â”‚
â”‚         'country': PAYEE_CONFIG['country']                                   â”‚
â”‚     }                                                                        â”‚
â”‚                                                                              â”‚
â”‚     # Debtor (Kunde) - optional                                              â”‚
â”‚     debtor_data = None                                                       â”‚
â”‚     if kunde.get('name') and kunde_plz and kunde_stadt:                      â”‚
â”‚         debtor_data = {                                                      â”‚
â”‚             'name': kunde['name'],                                           â”‚
â”‚             'street': kunde_strasse_komplett or None,                        â”‚
â”‚             'pcode': kunde_plz,                                              â”‚
â”‚             'city': kunde_stadt,                                             â”‚
â”‚             'country': 'CH'                                                  â”‚
â”‚         }                                                                    â”‚
â”‚                                                                              â”‚
â”‚     # QR Bill erstellen                                                      â”‚
â”‚     bill = QRBill(                                                           â”‚
â”‚         account=PAYEE_CONFIG['iban'],                                        â”‚
â”‚         creditor=creditor_data,                                              â”‚
â”‚         amount=f"{betrag:.2f}",                                              â”‚
â”‚         debtor=debtor_data,                                                  â”‚
â”‚         additional_information=f"Rechnung Nr. {rechnungs_nummer}"            â”‚
â”‚     )                                                                        â”‚
â”‚                                                                              â”‚
â”‚     # SVG generieren und zu Drawing konvertieren                             â”‚
â”‚     from tempfile import NamedTemporaryFile                                  â”‚
â”‚     with NamedTemporaryFile(suffix='.svg', delete=False) as tmp:             â”‚
â”‚         bill.as_svg(tmp.name)                                                â”‚
â”‚         drawing = svg2rlg(tmp.name)                                          â”‚
â”‚                                                                              â”‚
â”‚     return drawing                                                           â”‚
â”‚                                                                              â”‚
â”‚ 6.3 Rechnung-PDF erstellen                                                   â”‚
â”‚                                                                              â”‚
â”‚ def erstelle_rechnung_pdf(rapport, kunde, rechnungs_nummer):                 â”‚
â”‚     """Erstellt vollstÃ¤ndige Rechnung mit QR Bill fÃ¼r einen Rapport"""       â”‚
â”‚                                                                              â”‚
â”‚     buffer = BytesIO()                                                       â”‚
â”‚     doc = SimpleDocTemplate(                                                 â”‚
â”‚         buffer,                                                              â”‚
â”‚         pagesize=A4,                                                         â”‚
â”‚         rightMargin=2*cm,                                                    â”‚
â”‚         leftMargin=2*cm,                                                     â”‚
â”‚         topMargin=2*cm,                                                      â”‚
â”‚         bottomMargin=2*cm                                                    â”‚
â”‚     )                                                                        â”‚
â”‚     elements = []                                                            â”‚
â”‚     styles = getSampleStyleSheet()                                           â”‚
â”‚                                                                              â”‚
â”‚     # === HEADER / ABSENDER ===                                              â”‚
â”‚     elements.append(Paragraph(f'<b>{PAYEE_CONFIG["display_name"]}</b>',      â”‚
â”‚ styles['Title']))                                                            â”‚
â”‚     elements.append(Paragraph(PAYEE_CONFIG['address_line1'],                 â”‚
â”‚ styles['Normal']))                                                           â”‚
â”‚     elements.append(Paragraph(PAYEE_CONFIG['address_line2'],                 â”‚
â”‚ styles['Normal']))                                                           â”‚
â”‚     elements.append(Spacer(1, 1*cm))                                         â”‚
â”‚                                                                              â”‚
â”‚     # === KUNDE & RECHNUNG INFO ===                                          â”‚
â”‚     heute = format_date_ch(datetime.now().strftime('%Y-%m-%d'))              â”‚
â”‚                                                                              â”‚
â”‚     # Baue Kundenadresse aus strukturierten Feldern                          â”‚
â”‚     kunde_adresse_zeilen = []                                                â”‚
â”‚     strasse_komplett = f"{kunde.get('strasse', '')} {kunde.get('hausnummer', â”‚
â”‚  '')}".strip()                                                               â”‚
â”‚     if strasse_komplett:                                                     â”‚
â”‚         kunde_adresse_zeilen.append(strasse_komplett)                        â”‚
â”‚     plz_stadt = f"{kunde.get('plz', '')} {kunde.get('stadt', '')}".strip()   â”‚
â”‚     if plz_stadt:                                                            â”‚
â”‚         kunde_adresse_zeilen.append(plz_stadt)                               â”‚
â”‚                                                                              â”‚
â”‚     kunde_info = f"""                                                        â”‚
â”‚     <b>{kunde['name']}</b><br/>                                              â”‚
â”‚     {'<br/>'.join(kunde_adresse_zeilen)}                                     â”‚
â”‚     """                                                                      â”‚
â”‚     rechnung_info = f"""                                                     â”‚
â”‚     <b>Datum:</b> {heute}<br/>                                               â”‚
â”‚     <b>Rechnung Nr.:</b> {rechnungs_nummer}                                  â”‚
â”‚     """                                                                      â”‚
â”‚                                                                              â”‚
â”‚     info_table = Table([                                                     â”‚
â”‚         [Paragraph(kunde_info, styles['Normal']),                            â”‚
â”‚          Paragraph(rechnung_info, styles['Normal'])]                         â”‚
â”‚     ], colWidths=[10*cm, 7*cm])                                              â”‚
â”‚     elements.append(info_table)                                              â”‚
â”‚     elements.append(Spacer(1, 1.5*cm))                                       â”‚
â”‚                                                                              â”‚
â”‚     # === TITEL ===                                                          â”‚
â”‚     elements.append(Paragraph('<b>RECHNUNG</b>', styles['Heading2']))        â”‚
â”‚     elements.append(Spacer(1, 0.5*cm))                                       â”‚
â”‚                                                                              â”‚
â”‚     # === POSITIONEN TABELLE ===                                             â”‚
â”‚     data = [['Pos', 'Datum', 'Beschreibung', 'Dauer', 'Betrag (CHF)']]       â”‚
â”‚                                                                              â”‚
â”‚     thema_text = rapport['thema'][:50] + '...' if len(rapport['thema']) > 50 â”‚
â”‚  else rapport['thema']                                                       â”‚
â”‚     dauer_std = rapport['dauer_minuten'] / 60                                â”‚
â”‚                                                                              â”‚
â”‚     data.append([                                                            â”‚
â”‚         '1',                                                                 â”‚
â”‚         format_date_ch(rapport['datum']),                                    â”‚
â”‚         thema_text,                                                          â”‚
â”‚         f"{rapport['dauer_minuten']} min",                                   â”‚
â”‚         f"{rapport['kosten']:.2f}"                                           â”‚
â”‚     ])                                                                       â”‚
â”‚                                                                              â”‚
â”‚     # Total Zeile                                                            â”‚
â”‚     data.append(['', '', '', '<b>Total CHF:</b>',                            â”‚
â”‚ f"<b>{rapport['kosten']:.2f}</b>"])                                          â”‚
â”‚                                                                              â”‚
â”‚     table = Table(data, colWidths=[1.5*cm, 2.5*cm, 8*cm, 2.5*cm, 2.5*cm])    â”‚
â”‚     table.setStyle(TableStyle([                                              â”‚
â”‚         ('BACKGROUND', (0, 0), (-1, 0), colors.grey),                        â”‚
â”‚         ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),                   â”‚
â”‚         ('ALIGN', (0, 0), (-1, -1), 'LEFT'),                                 â”‚
â”‚         ('ALIGN', (4, 0), (4, -1), 'RIGHT'),                                 â”‚
â”‚         ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),                     â”‚
â”‚         ('FONTSIZE', (0, 0), (-1, 0), 10),                                   â”‚
â”‚         ('BOTTOMPADDING', (0, 0), (-1, 0), 12),                              â”‚
â”‚         ('GRID', (0, 0), (-1, -2), 1, colors.black),                         â”‚
â”‚         ('LINEABOVE', (3, -1), (-1, -1), 2, colors.black),                   â”‚
â”‚     ]))                                                                      â”‚
â”‚                                                                              â”‚
â”‚     elements.append(table)                                                   â”‚
â”‚     elements.append(Spacer(1, 1*cm))                                         â”‚
â”‚                                                                              â”‚
â”‚     # === ZAHLUNGSBEDINGUNGEN ===                                            â”‚
â”‚     elements.append(Paragraph('Zahlbar innert 30 Tagen', styles['Normal']))  â”‚
â”‚     elements.append(Spacer(1, 1*cm))                                         â”‚
â”‚                                                                              â”‚
â”‚     # === QR BILL ===                                                        â”‚
â”‚     try:                                                                     â”‚
â”‚         qr_drawing = generiere_qr_rechnung(rapport['kosten'], kunde,         â”‚
â”‚ rechnungs_nummer)                                                            â”‚
â”‚         if qr_drawing:                                                       â”‚
â”‚             # Skaliere auf passende GrÃ¶sse                                   â”‚
â”‚             qr_drawing.width = 17*cm                                         â”‚
â”‚             qr_drawing.height = 10.5*cm                                      â”‚
â”‚             qr_drawing.scale(1, 1)                                           â”‚
â”‚             elements.append(qr_drawing)                                      â”‚
â”‚     except Exception as e:                                                   â”‚
â”‚         error_text = f'<b style="color:red">FEHLER:</b> QR-Rechnung konnte   â”‚
â”‚ nicht generiert werden: {str(e)}'                                            â”‚
â”‚         elements.append(Paragraph(error_text, styles['Normal']))             â”‚
â”‚                                                                              â”‚
â”‚     # PDF erstellen                                                          â”‚
â”‚     doc.build(elements)                                                      â”‚
â”‚     buffer.seek(0)                                                           â”‚
â”‚                                                                              â”‚
â”‚     return buffer.getvalue()                                                 â”‚
â”‚                                                                              â”‚
â”‚ 7. Route implementieren                                                      â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/main.py (nach bestehenden Routen, vor @app.teardown_appcontext)   â”‚
â”‚                                                                              â”‚
â”‚ @app.route('/rechnung/rapport/<int:rapport_id>')                             â”‚
â”‚ @auth.login_required                                                         â”‚
â”‚ def rechnung_einzeln(rapport_id):                                            â”‚
â”‚     """Erstellt Rechnung fÃ¼r einzelnen Rapport"""                            â”‚
â”‚     db = get_db()                                                            â”‚
â”‚                                                                              â”‚
â”‚     # Lade Rapport mit Kundendaten                                           â”‚
â”‚     row = db.execute('''                                                     â”‚
â”‚         SELECT r.*, k.name as kunde_name, k.email, k.telefon, k.adresse,     â”‚
â”‚                k.strasse, k.hausnummer, k.plz, k.stadt,                      â”‚
â”‚                k.it_infrastruktur, k.stundensatz                             â”‚
â”‚         FROM rapporte r                                                      â”‚
â”‚         JOIN kunden k ON r.kunde_id = k.id                                   â”‚
â”‚         WHERE r.id = ?                                                       â”‚
â”‚     ''', (rapport_id,)).fetchone()                                           â”‚
â”‚                                                                              â”‚
â”‚     if not row:                                                              â”‚
â”‚         return "Rapport nicht gefunden", 404                                 â”‚
â”‚                                                                              â”‚
â”‚     # Konvertiere zu Dicts fÃ¼r einfacheren Zugriff                           â”‚
â”‚     rapport = {                                                              â”‚
â”‚         'id': row['id'],                                                     â”‚
â”‚         'kunde_id': row['kunde_id'],                                         â”‚
â”‚         'datum': row['datum'],                                               â”‚
â”‚         'dauer_minuten': row['dauer_minuten'],                               â”‚
â”‚         'thema': row['thema'],                                               â”‚
â”‚         'kosten': row['kosten'],                                             â”‚
â”‚         'bezahlt': row['bezahlt'],                                           â”‚
â”‚         'zahlungsart': row['zahlungsart']                                    â”‚
â”‚     }                                                                        â”‚
â”‚     kunde = {                                                                â”‚
â”‚         'name': row['kunde_name'],                                           â”‚
â”‚         'email': row['email'],                                               â”‚
â”‚         'adresse': row['adresse'],  # Fallback fÃ¼r alte Daten                â”‚
â”‚         'strasse': row['strasse'],                                           â”‚
â”‚         'hausnummer': row['hausnummer'],                                     â”‚
â”‚         'plz': row['plz'],                                                   â”‚
â”‚         'stadt': row['stadt']                                                â”‚
â”‚     }                                                                        â”‚
â”‚                                                                              â”‚
â”‚     # Validierung                                                            â”‚
â”‚     if not PAYEE_CONFIG['iban']:                                             â”‚
â”‚         return "Fehler: IBAN nicht konfiguriert. Bitte PAYEE_IBAN in         â”‚
â”‚ docker-compose.yml setzen.", 500                                             â”‚
â”‚                                                                              â”‚
â”‚     if not rapport['kosten'] or rapport['kosten'] <= 0:                      â”‚
â”‚         return "Fehler: Rapport hat keinen gÃ¼ltigen Betrag.", 400            â”‚
â”‚                                                                              â”‚
â”‚     # Generiere Rechnungsnummer                                              â”‚
â”‚     rechnungs_nummer = generiere_rechnungsnummer()                           â”‚
â”‚                                                                              â”‚
â”‚     # Speichere Rechnung in DB                                               â”‚
â”‚     db.execute(                                                              â”‚
â”‚         'INSERT INTO rechnungen (rechnungs_nummer, kunde_id, betrag,         â”‚
â”‚ rapport_ids) VALUES (?, ?, ?, ?)',                                           â”‚
â”‚         (rechnungs_nummer, rapport['kunde_id'], rapport['kosten'],           â”‚
â”‚ str(rapport_id))                                                             â”‚
â”‚     )                                                                        â”‚
â”‚     db.commit()                                                              â”‚
â”‚                                                                              â”‚
â”‚     # Generiere PDF                                                          â”‚
â”‚     try:                                                                     â”‚
â”‚         pdf_bytes = erstelle_rechnung_pdf(rapport, kunde, rechnungs_nummer)  â”‚
â”‚     except Exception as e:                                                   â”‚
â”‚         return f"Fehler beim Erstellen der Rechnung: {str(e)}", 500          â”‚
â”‚                                                                              â”‚
â”‚     # RÃ¼ckgabe als Download                                                  â”‚
â”‚     response = make_response(pdf_bytes)                                      â”‚
â”‚     response.headers['Content-Type'] = 'application/pdf'                     â”‚
â”‚     response.headers['Content-Disposition'] = f'attachment;                  â”‚
â”‚ filename=Rechnung_{rechnungs_nummer}.pdf'                                    â”‚
â”‚                                                                              â”‚
â”‚     return response                                                          â”‚
â”‚                                                                              â”‚
â”‚ 8. Kunden-Formulare anpassen                                                 â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/templates/kunde_form.html                                         â”‚
â”‚                                                                              â”‚
â”‚ Ersetze das Adresse-Feld durch separate Felder:                              â”‚
â”‚                                                                              â”‚
â”‚ <!-- Statt eines grossen Adresse-Textareas: -->                              â”‚
â”‚ <div>                                                                        â”‚
â”‚     <label for="strasse">Strasse:</label>                                    â”‚
â”‚     <input type="text" id="strasse" name="strasse" value="{{ kunde.strasse   â”‚
â”‚ if kunde else '' }}">                                                        â”‚
â”‚ </div>                                                                       â”‚
â”‚                                                                              â”‚
â”‚ <div>                                                                        â”‚
â”‚     <label for="hausnummer">Hausnummer:</label>                              â”‚
â”‚     <input type="text" id="hausnummer" name="hausnummer" value="{{           â”‚
â”‚ kunde.hausnummer if kunde else '' }}" style="width: 100px;">                 â”‚
â”‚ </div>                                                                       â”‚
â”‚                                                                              â”‚
â”‚ <div>                                                                        â”‚
â”‚     <label for="plz">PLZ:</label>                                            â”‚
â”‚     <input type="text" id="plz" name="plz" value="{{ kunde.plz if kunde else â”‚
â”‚  '' }}" pattern="[0-9]{4}" style="width: 100px;">                            â”‚
â”‚ </div>                                                                       â”‚
â”‚                                                                              â”‚
â”‚ <div>                                                                        â”‚
â”‚     <label for="stadt">Stadt:</label>                                        â”‚
â”‚     <input type="text" id="stadt" name="stadt" value="{{ kunde.stadt if      â”‚
â”‚ kunde else '' }}">                                                           â”‚
â”‚ </div>                                                                       â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/main.py                                                           â”‚
â”‚                                                                              â”‚
â”‚ In den Routen kunde_neu und kunde_bearbeiten die neuen Felder verarbeiten:   â”‚
â”‚                                                                              â”‚
â”‚ # In kunde_neu (Zeile ~118-123):                                             â”‚
â”‚ db.execute(                                                                  â”‚
â”‚     'INSERT INTO kunden (name, email, telefon, strasse, hausnummer, plz,     â”‚
â”‚ stadt, it_infrastruktur, stundensatz) '                                      â”‚
â”‚     'VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)',                                    â”‚
â”‚     (request.form['name'], request.form['email'], request.form['telefon'],   â”‚
â”‚      request.form.get('strasse', ''), request.form.get('hausnummer', ''),    â”‚
â”‚      request.form.get('plz', ''), request.form.get('stadt', ''),             â”‚
â”‚      request.form['it_infrastruktur'], request.form.get('stundensatz',       â”‚
â”‚ 120.0))                                                                      â”‚
â”‚ )                                                                            â”‚
â”‚                                                                              â”‚
â”‚ # In kunde_bearbeiten (Zeile ~205-210):                                      â”‚
â”‚ db.execute(                                                                  â”‚
â”‚     'UPDATE kunden SET name=?, email=?, telefon=?, strasse=?, hausnummer=?,  â”‚
â”‚ plz=?, stadt=?, it_infrastruktur=?, stundensatz=? WHERE id=?',               â”‚
â”‚     (request.form['name'], request.form['email'], request.form['telefon'],   â”‚
â”‚      request.form.get('strasse', ''), request.form.get('hausnummer', ''),    â”‚
â”‚      request.form.get('plz', ''), request.form.get('stadt', ''),             â”‚
â”‚      request.form['it_infrastruktur'], request.form.get('stundensatz',       â”‚
â”‚ 120.0), kunde_id)                                                            â”‚
â”‚ )                                                                            â”‚
â”‚                                                                              â”‚
â”‚ 9. UI-Integration: Rechnung-Buttons                                          â”‚
â”‚                                                                              â”‚
â”‚ Datei: app/templates/index.html                                              â”‚
â”‚                                                                              â”‚
â”‚ In der Rapporte-Tabelle neue Spalte hinzufÃ¼gen:                              â”‚
â”‚                                                                              â”‚
â”‚ 1. Im <thead> nach der letzten <th>:                                         â”‚
â”‚ <th>Rechnung</th>                                                            â”‚
â”‚                                                                              â”‚
â”‚ 2. Im <tbody> nach der letzten <td> (innerhalb der for-Schleife):            â”‚
â”‚ <td>                                                                         â”‚
â”‚     <a href="/rechnung/rapport/{{ rapport.id }}" class="btn"                 â”‚
â”‚ style="font-size: 0.9em; padding: 0.3em 0.6em;">                             â”‚
â”‚         ðŸ“„ Rechnung                                                          â”‚
â”‚     </a>                                                                     â”‚
â”‚ </td>                                                                        â”‚
â”‚                                                                              â”‚
â”‚ Optional: Ã„hnliche Buttons in kunde_detail.html bei der Rapporte-Liste       â”‚
â”‚ hinzufÃ¼gen.                                                                  â”‚
â”‚                                                                              â”‚
â”‚ Hinweis: Der Rapport-Text (thema) ist bereits im Plan und wird auf der       â”‚
â”‚ Rechnung als "Beschreibung" angezeigt (siehe Variable thema_text in          â”‚
â”‚ erstelle_rechnung_pdf).                                                      â”‚
â”‚                                                                              â”‚
â”‚ Verification / Testing                                                       â”‚
â”‚                                                                              â”‚
â”‚ Setup testen                                                                 â”‚
â”‚                                                                              â”‚
â”‚ # 0. BACKUP ERSTELLT? (siehe Schritt 0 oben!)                                â”‚
â”‚                                                                              â”‚
â”‚ # 1. Migration ausfÃ¼hren                                                     â”‚
â”‚ python3 migrate_adressen.py                                                  â”‚
â”‚                                                                              â”‚
â”‚ # 2. Migrierte Daten prÃ¼fen                                                  â”‚
â”‚ docker exec -it rapporte-web-1 sqlite3 /app/data/rapporte.db                 â”‚
â”‚ sqlite> SELECT id, name, strasse, hausnummer, plz, stadt FROM kunden LIMIT   â”‚
â”‚ 5;                                                                           â”‚
â”‚ sqlite> .exit                                                                â”‚
â”‚                                                                              â”‚
â”‚ # 3. Container neu bauen                                                     â”‚
â”‚ docker-compose down                                                          â”‚
â”‚ docker-compose up --build -d                                                 â”‚
â”‚                                                                              â”‚
â”‚ # 4. Logs prÃ¼fen                                                             â”‚
â”‚ docker-compose logs -f web                                                   â”‚
â”‚                                                                              â”‚
â”‚ # 5. App Ã¶ffnen                                                              â”‚
â”‚ open http://localhost:8085                                                   â”‚
â”‚                                                                              â”‚
â”‚ Funktionstest                                                                â”‚
â”‚                                                                              â”‚
â”‚ 1. Login: Mit admin/changeme einloggen                                       â”‚
â”‚ 2. Rapport auswÃ¤hlen: Auf Hauptseite Rapport mit Kosten > 0 wÃ¤hlen           â”‚
â”‚ 3. Rechnung erstellen: "ðŸ“„ Rechnung" Button klicken                          â”‚
â”‚ 4. PDF prÃ¼fen:                                                               â”‚
â”‚   - Wird PDF heruntergeladen?                                                â”‚
â”‚   - Ist Rechnungsnummer korrekt (RE-YYYYMMDD-XXXXX)?                         â”‚
â”‚   - Sind Kundendaten sichtbar?                                               â”‚
â”‚   - Ist QR-Code vorhanden?                                                   â”‚
â”‚ 5. QR-Code scannen:                                                          â”‚
â”‚   - Mit Banking-App (UBS, Raiffeisen, PostFinance, etc.) scannen             â”‚
â”‚   - IBAN, Betrag, EmpfÃ¤nger prÃ¼fen                                           â”‚
â”‚   - Rechnungsnummer in Mitteilung prÃ¼fen                                     â”‚
â”‚ 6. Datenbank prÃ¼fen:                                                         â”‚
â”‚ docker exec -it rapporte-web-1 sqlite3 /app/data/rapporte.db                 â”‚
â”‚ sqlite> SELECT * FROM rechnungen;                                            â”‚
â”‚ sqlite> .exit                                                                â”‚
â”‚                                                                              â”‚
â”‚ Edge Cases testen                                                            â”‚
â”‚                                                                              â”‚
â”‚ - Rapport ohne Kundenadresse (sollte QR-Code ohne Debtor generieren)         â”‚
â”‚ - Kunde mit alten Daten (nur adresse-Feld, keine neuen Felder) - Fallback    â”‚
â”‚ funktioniert?                                                                â”‚
â”‚ - Mehrfache Rechnungen am selben Tag (Sequenznummer erhÃ¶ht sich?)            â”‚
â”‚ - Lange Rapport-Beschreibung (thema > 50 Zeichen, Trunkierung funktioniert?) â”‚
â”‚ - Fehlende IBAN (zeigt Fehler-Meldung?)                                      â”‚
â”‚ - Neuer Kunde anlegen mit separaten Adressfeldern                            â”‚
â”‚                                                                              â”‚
â”‚ Produktion                                                                   â”‚
â”‚                                                                              â”‚
â”‚ - Echte IBAN aus Dietipi-App in docker-compose.yml eintragen                 â”‚
â”‚ - Alle PAYEE_* Variablen mit echten Daten fÃ¼llen                             â”‚
â”‚ - Test-Rechnung erstellen und mit Banking-App scannen                        â”‚
â”‚ - Container neu starten: docker-compose restart                              â”‚
â”‚                                                                              â”‚
â”‚ ErweiterungsmÃ¶glichkeiten (spÃ¤ter)                                           â”‚
â”‚                                                                              â”‚
â”‚ Nach erfolgreichem MVP:                                                      â”‚
â”‚                                                                              â”‚
â”‚ 1. Multi-Rapport-Rechnungen: Mehrere Rapporte auf einer Rechnung             â”‚
â”‚ 2. Rechnungs-Liste: /rechnungen Route mit Ãœbersicht aller Rechnungen         â”‚
â”‚ 3. Nachdrucken: Button zum erneuten Generieren bestehender Rechnungen        â”‚
â”‚ 4. QRR-Referenzen: Strukturierte Referenznummern fÃ¼r automatischen Abgleich  â”‚
â”‚ 5. MwSt-Berechnung: Falls MwSt-pflichtig wird                                â”‚
â”‚ 6. E-Mail-Versand: Rechnung direkt an Kunden mailen                          â”‚
â”‚ 7. Zahlungs-Tracking: Bezahlt-Status mit Rechnung verknÃ¼pfen                 â”‚
â”‚                                                                              â”‚
â”‚ Risiken & Mitigations                                                        â”‚
â”‚ Risiko: QR-Code scannt nicht                                                 â”‚
â”‚ Mitigation: IBAN-Format validieren; mit mehreren Banking-Apps testen         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚ Risiko: SVG-Konvertierung schlÃ¤gt fehl                                       â”‚
â”‚ Mitigation: Try-catch um QR-Generierung; Fehler-Paragraph anzeigen           â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚ Risiko: Rechnungsnummer-Kollision                                            â”‚
â”‚ Mitigation: UNIQUE constraint in DB; Transaktion fÃ¼r INSERT verwenden        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚ Risiko: Fehlende Kundenadresse                                               â”‚
â”‚ Mitigation: Graceful handling: QR ohne Debtor, Warnung im PDF                â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                     â”‚
â”‚ Risiko: PDF-Layout bricht                                                    â”‚
â”‚ Mitigation: Lange Texte trunkieren; A4-Masse einhalten                       â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

â— Ich werde nun die Swiss QR Bill Rechnungsfunktion gemÃ¤ÃŸ dem Plan
  implementieren. Beginnen wir mit dem KRITISCHEN ersten Schritt: 
  Datenbank-Backup.

â— Bash(cp data/rapporte.db data/rapporte_backup_$(date +%Y%m%d_%H%M%S).db && ls
      -lh data/rapporte_backup_*.db)
  âŽ¿ Â Error: Exit code 1
     cp: der Aufruf von stat fÃ¼r 'data/rapporte.db' ist nicht mÃ¶glich: Datei ode
      Verzeichnis nicht gefunden

â— Die Datei liegt vermutlich im Docker-Container. Lassen Sie mich erst prÃ¼fen,
  ob der Container lÃ¤uft:

â— Bash(docker ps | grep rapporte)
  âŽ¿ Â /bin/bash: Zeile 1: docker: Kommando nicht gefunden

â— Docker ist nicht verfÃ¼gbar. Lassen Sie mich prÃ¼fen, ob die Datei lokal
  existiert:

â— Searched for 1 pattern (ctrl+o to expand)

â— Die Datenbank existiert noch nicht - das ist in Ordnung fÃ¼r die Entwicklung.
  Ich beginne mit der Implementierung. ZunÃ¤chst erstelle ich eine Todo-Liste:

â— Perfekt! Jetzt beginne ich mit der Implementierung:

  Task #1: Dependencies hinzufÃ¼gen

â— Read 1 file (ctrl+o to expand)

â— Update(requirements.txt)
  âŽ¿ Â Added 2 lines
      2  Werkzeug==3.0.1
      3  reportlab==4.0.7
      4  Flask-HTTPAuth==4.8.0
      5 +qrbill==1.2.0                                                   
      6 +svglib==1.5.1                                                   

â— Task #2: Datenbank-Schema erweitern

â— Read 1 file (ctrl+o to expand)

â— Update(app/database.py)
  âŽ¿ Â Added 4 lines
      23              email TEXT,
      24              telefon TEXT,
      25              adresse TEXT,
      26 +            strasse TEXT,                                      
      27 +            hausnummer TEXT,                                   
      28 +            plz TEXT,                                          
      29 +            stadt TEXT,                                        
      30              it_infrastruktur TEXT,
      31              stundensatz REAL DEFAULT 120.0,
      32              erstellt_am TIMESTAMP DEFAULT CURRENT_TIMESTAMP

â— Update(app/database.py)
  âŽ¿ Â Added 14 lines, removed 1 line
      62              FOREIGN KEY (kunde_id) REFERENCES kunden (id)
      63          )
      64      ''')
      65 -                                                               
      65 +                                                               
      66 +    # Rechnungen Tabelle                                       
      67 +    db.execute('''                                             
      68 +        CREATE TABLE IF NOT EXISTS rechnungen (                
      69 +            id INTEGER PRIMARY KEY AUTOINCREMENT,              
      70 +            rechnungs_nummer TEXT UNIQUE NOT NULL,             
      71 +            kunde_id INTEGER NOT NULL,                         
      72 +            erstellt_am TIMESTAMP DEFAULT CURRENT_TIMESTAMP,   
      73 +            betrag REAL NOT NULL,                              
      74 +            rapport_ids TEXT NOT NULL,                         
      75 +            FOREIGN KEY (kunde_id) REFERENCES kunden (id)      
      76 +        )                                                      
      77 +    ''')                                                       
      78 +                                                               
      79      db.commit()

â— Task #3: Migrations-Script erstellen

â— Write(migrate_adressen.py)
  âŽ¿ Â Wrote 76 lines to migrate_adressen.py
       1 #!/usr/bin/env python3
       2 """
       3 Migriert bestehende Adressen (Freitext) in separate Felder.
       4 Einmalig nach Schema-Update ausfÃ¼hren!
       5 """
       6 import sqlite3
       7 import re
       8 
       9 def parse_adresse(adresse_text):
      10     """Versucht Adresse in Komponenten zu zerlegen"""
     â€¦ +66 lines (ctrl+o to expand)

â— Bash(chmod +x /home/asiend/dev/Rapporte/migrate_adressen.py)
  âŽ¿ Â (No content)

â— Task #4: Payment-Konfiguration und Imports hinzufÃ¼gen

â— Read 1 file (ctrl+o to expand)

â— Update(app/main.py)
  âŽ¿ Â Added 2 lines
      11  from reportlab.lib.styles import getSampleStyleSheet
      12  from reportlab.lib.units import cm
      13  from datetime import datetime
      14 +from qrbill import QRBill                                      
      15 +from svglib.svglib import svg2rlg                              
      16  
      17  app = Flask(__name__)
      18  app.config['DATABASE'] = os.environ.get('DATABASE_PATH', '/app/
          data/rapporte.db')

â— Update(app/main.py)
  âŽ¿ Â Added 12 lines
      27      os.environ.get('AUTH_USERNAME', 'admin'): os.environ.get('A
          UTH_PASSWORD_HASH', 'scrypt:32768:8:1$4xQJ5Z8LGFqPHYmH$c8e0c3d8
          a5f5e9c8b0f1e3d7a9c6b4f2e1d8a7b5c3f0e2d9a8b6c4f1e3d7a9c5b2f0e1d
          8a7b6c3f2e0d9a8b5c4f1e3d7')
      28  }
      29  
      30 +# Payment/Rechnungs-Konfiguration                              
      31 +PAYEE_CONFIG = {                                               
      32 +    'legal_name': os.environ.get('PAYEE_LEGAL_NAME', ''),      
      33 +    'iban': os.environ.get('PAYEE_IBAN', ''),                  
      34 +    'bank': os.environ.get('PAYEE_BANK', ''),                  
      35 +    'bic': os.environ.get('PAYEE_BIC', ''),                    
      36 +    'display_name': os.environ.get('PAYEE_DISPLAY_NAME', ''),  
      37 +    'address_line1': os.environ.get('PAYEE_ADDRESS_LINE1', ''),
      38 +    'address_line2': os.environ.get('PAYEE_ADDRESS_LINE2', ''),
      39 +    'country': os.environ.get('PAYEE_COUNTRY', 'CH')           
      40 +}                                                              
      41 +                                                               
      42  @auth.verify_password
      43  def verify_password(username, password):
      44      if username in users and check_password_hash(users.get(user
          name), password):

â— Task #5: Helper-Funktionen implementieren

â— Read 1 file (ctrl+o to expand)

â— Update(app/main.py)
  âŽ¿ Â Added 174 lines
       62              return f"{parts[2]}.{parts[1]}.{parts[0]}"
       63      return date_str
       64  
       65 +def generiere_rechnungsnummer():                              
       66 +    """Generiert eindeutige Rechnungsnummer im Format RE-YYYYM
          +MDD-XXXXX"""                                                  
       67 +    db = get_db()                                             
       68 +    today = datetime.now().strftime("%Y%m%d")                 
       69 +                                                              
       70 +    # ZÃ¤hle Rechnungen von heute                              
       71 +    count = db.execute(                                       
       72 +        "SELECT COUNT(*) as cnt FROM rechnungen WHERE rechnung
          +s_nummer LIKE ?",                                             
       73 +        (f"RE-{today}-%",)                                    
       74 +    ).fetchone()['cnt']                                       
       75 +                                                              
       76 +    return f"RE-{today}-{count+1:05d}"                        
       77 +                                                              
       78 +def generiere_qr_rechnung(betrag, kunde, rechnungs_nummer):   
       79 +    """Generiert Swiss QR Bill als ReportLab Drawing"""       
       80 +                                                              
       81 +    if not PAYEE_CONFIG['iban']:                              
       82 +        raise ValueError("PAYEE_IBAN nicht konfiguriert")     
       83 +                                                              
       84 +    # Nutze strukturierte Adressfelder (neue Struktur)        
       85 +    kunde_strasse = kunde.get('strasse', '') or ''            
       86 +    kunde_hausnummer = kunde.get('hausnummer', '') or ''      
       87 +    kunde_plz = kunde.get('plz', '') or ''                    
       88 +    kunde_stadt = kunde.get('stadt', '') or ''                
       89 +                                                              
       90 +    # VollstÃ¤ndige Strasse fÃ¼r QR Bill                        
       91 +    kunde_strasse_komplett = f"{kunde_strasse} {kunde_hausnumm
          +er}".strip() if kunde_strasse else ''                         
       92 +                                                              
       93 +    # Creditor (Rechnungssteller)                             
       94 +    creditor_plz_ort = PAYEE_CONFIG['address_line2'].split(max
          +split=1)                                                      
       95 +    creditor_data = {                                         
       96 +        'name': PAYEE_CONFIG['legal_name'],                   
       97 +        'pcode': creditor_plz_ort[0] if len(creditor_plz_ort) 
          +> 0 else '8000',                                              
       98 +        'city': creditor_plz_ort[1] if len(creditor_plz_ort) >
          + 1 else 'ZÃ¼rich',                                             
       99 +        'country': PAYEE_CONFIG['country']                    
      100 +    }                                                         
      101 +                                                              
      102 +    # Debtor (Kunde) - optional                               
      103 +    debtor_data = None                                        
      104 +    if kunde.get('name') and kunde_plz and kunde_stadt:       
      105 +        debtor_data = {                                       
      106 +            'name': kunde['name'],                            
      107 +            'street': kunde_strasse_komplett or None,         
      108 +            'pcode': kunde_plz,                               
      109 +            'city': kunde_stadt,                              
      110 +            'country': 'CH'                                   
      111 +        }                                                     
      112 +                                                              
      113 +    # QR Bill erstellen                                       
      114 +    bill = QRBill(                                            
      115 +        account=PAYEE_CONFIG['iban'],                         
      116 +        creditor=creditor_data,                               
      117 +        amount=f"{betrag:.2f}",                               
      118 +        debtor=debtor_data,                                   
      119 +        additional_information=f"Rechnung Nr. {rechnungs_numme
          +r}"                                                           
      120 +    )                                                         
      121 +                                                              
      122 +    # SVG generieren und zu Drawing konvertieren              
      123 +    from tempfile import NamedTemporaryFile                   
      124 +    with NamedTemporaryFile(suffix='.svg', delete=False) as tm
          +p:                                                            
      125 +        bill.as_svg(tmp.name)                                 
      126 +        drawing = svg2rlg(tmp.name)                           
      127 +                                                              
      128 +    return drawing                                            
      129 +                                                              
      130 +def erstelle_rechnung_pdf(rapport, kunde, rechnungs_nummer):  
      131 +    """Erstellt vollstÃ¤ndige Rechnung mit QR Bill fÃ¼r einen Ra
          +pport"""                                                      
      132 +                                                              
      133 +    buffer = BytesIO()                                        
      134 +    doc = SimpleDocTemplate(                                  
      135 +        buffer,                                               
      136 +        pagesize=A4,                                          
      137 +        rightMargin=2*cm,                                     
      138 +        leftMargin=2*cm,                                      
      139 +        topMargin=2*cm,                                       
      140 +        bottomMargin=2*cm                                     
      141 +    )                                                         
      142 +    elements = []                                             
      143 +    styles = getSampleStyleSheet()                            
      144 +                                                              
      145 +    # === HEADER / ABSENDER ===                               
      146 +    elements.append(Paragraph(f'<b>{PAYEE_CONFIG["display_name
          +"]}</b>', styles['Title']))                                   
      147 +    elements.append(Paragraph(PAYEE_CONFIG['address_line1'], s
          +tyles['Normal']))                                             
      148 +    elements.append(Paragraph(PAYEE_CONFIG['address_line2'], s
          +tyles['Normal']))                                             
      149 +    elements.append(Spacer(1, 1*cm))                          
      150 +                                                              
      151 +    # === KUNDE & RECHNUNG INFO ===                           
      152 +    heute = format_date_ch(datetime.now().strftime('%Y-%m-%d')
          +)                                                             
      153 +                                                              
      154 +    # Baue Kundenadresse aus strukturierten Feldern           
      155 +    kunde_adresse_zeilen = []                                 
      156 +    strasse_komplett = f"{kunde.get('strasse', '')} {kunde.get
          +('hausnummer', '')}".strip()                                  
      157 +    if strasse_komplett:                                      
      158 +        kunde_adresse_zeilen.append(strasse_komplett)         
      159 +    plz_stadt = f"{kunde.get('plz', '')} {kunde.get('stadt', '
          +')}".strip()                                                  
      160 +    if plz_stadt:                                             
      161 +        kunde_adresse_zeilen.append(plz_stadt)                
      162 +                                                              
      163 +    kunde_info = f"""                                         
      164 +    <b>{kunde['name']}</b><br/>                               
      165 +    {'<br/>'.join(kunde_adresse_zeilen)}                      
      166 +    """                                                       
      167 +    rechnung_info = f"""                                      
      168 +    <b>Datum:</b> {heute}<br/>                                
      169 +    <b>Rechnung Nr.:</b> {rechnungs_nummer}                   
      170 +    """                                                       
      171 +                                                              
      172 +    info_table = Table([                                      
      173 +        [Paragraph(kunde_info, styles['Normal']),             
      174 +         Paragraph(rechnung_info, styles['Normal'])]          
      175 +    ], colWidths=[10*cm, 7*cm])                               
      176 +    elements.append(info_table)                               
      177 +    elements.append(Spacer(1, 1.5*cm))                        
      178 +                                                              
      179 +    # === TITEL ===                                           
      180 +    elements.append(Paragraph('<b>RECHNUNG</b>', styles['Headi
          +ng2']))                                                       
      181 +    elements.append(Spacer(1, 0.5*cm))                        
      182 +                                                              
      183 +    # === POSITIONEN TABELLE ===                              
      184 +    data = [['Pos', 'Datum', 'Beschreibung', 'Dauer', 'Betrag 
          +(CHF)']]                                                      
      185 +                                                              
      186 +    thema_text = rapport['thema'][:50] + '...' if len(rapport[
          +'thema']) > 50 else rapport['thema']                          
      187 +    dauer_std = rapport['dauer_minuten'] / 60                 
      188 +                                                              
      189 +    data.append([                                             
      190 +        '1',                                                  
      191 +        format_date_ch(rapport['datum']),                     
      192 +        thema_text,                                           
      193 +        f"{rapport['dauer_minuten']} min",                    
      194 +        f"{rapport['kosten']:.2f}"                            
      195 +    ])                                                        
      196 +                                                              
      197 +    # Total Zeile                                             
      198 +    data.append(['', '', '', '<b>Total CHF:</b>', f"<b>{rappor
          +t['kosten']:.2f}</b>"])                                       
      199 +                                                              
      200 +    table = Table(data, colWidths=[1.5*cm, 2.5*cm, 8*cm, 2.5*c
          +m, 2.5*cm])                                                   
      201 +    table.setStyle(TableStyle([                               
      202 +        ('BACKGROUND', (0, 0), (-1, 0), colors.grey),         
      203 +        ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),    
      204 +        ('ALIGN', (0, 0), (-1, -1), 'LEFT'),                  
      205 +        ('ALIGN', (4, 0), (4, -1), 'RIGHT'),                  
      206 +        ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),      
      207 +        ('FONTSIZE', (0, 0), (-1, 0), 10),                    
      208 +        ('BOTTOMPADDING', (0, 0), (-1, 0), 12),               
      209 +        ('GRID', (0, 0), (-1, -2), 1, colors.black),          
      210 +        ('LINEABOVE', (3, -1), (-1, -1), 2, colors.black),    
      211 +    ]))                                                       
      212 +                                                              
      213 +    elements.append(table)                                    
      214 +    elements.append(Spacer(1, 1*cm))                          
      215 +                                                              
      216 +    # === ZAHLUNGSBEDINGUNGEN ===                             
      217 +    elements.append(Paragraph('Zahlbar innert 30 Tagen', style
          +s['Normal']))                                                 
      218 +    elements.append(Spacer(1, 1*cm))                          
      219 +                                                              
      220 +    # === QR BILL ===                                         
      221 +    try:                                                      
      222 +        qr_drawing = generiere_qr_rechnung(rapport['kosten'], 
          +kunde, rechnungs_nummer)                                      
      223 +        if qr_drawing:                                        
      224 +            # Skaliere auf passende GrÃ¶sse                    
      225 +            qr_drawing.width = 17*cm                          
      226 +            qr_drawing.height = 10.5*cm                       
      227 +            qr_drawing.scale(1, 1)                            
      228 +            elements.append(qr_drawing)                       
      229 +    except Exception as e:                                    
      230 +        error_text = f'<b style="color:red">FEHLER:</b> QR-Rec
          +hnung konnte nicht generiert werden: {str(e)}'                
      231 +        elements.append(Paragraph(error_text, styles['Normal']
          +))                                                            
      232 +                                                              
      233 +    # PDF erstellen                                           
      234 +    doc.build(elements)                                       
      235 +    buffer.seek(0)                                            
      236 +                                                              
      237 +    return buffer.getvalue()                                  
      238 +                                                              
      239  app.jinja_env.filters['date_ch'] = format_date_ch
      240  
      241  @app.route('/')

â— Task #6: Rechnung-Route implementieren

â— Searched for 1 pattern, read 1 file (ctrl+o to expand)

â— Update(app/main.py)
  âŽ¿ Â Added 70 lines
      614      response.headers['Content-Disposition'] = f'attachment; fi
           lename=rapporte_{datetime.now().strftime("%Y%m%d")}.pdf'
      615      return response
      616  
      617 +@app.route('/rechnung/rapport/<int:rapport_id>')              
      618 +@auth.login_required                                          
      619 +def rechnung_einzeln(rapport_id):                             
      620 +    """Erstellt Rechnung fÃ¼r einzelnen Rapport"""             
      621 +    db = get_db()                                             
      622 +                                                              
      623 +    # Lade Rapport mit Kundendaten                            
      624 +    row = db.execute('''                                      
      625 +        SELECT r.*, k.name as kunde_name, k.email, k.telefon, 
          +k.adresse,                                                    
      626 +               k.strasse, k.hausnummer, k.plz, k.stadt,       
      627 +               k.it_infrastruktur, k.stundensatz              
      628 +        FROM rapporte r                                       
      629 +        JOIN kunden k ON r.kunde_id = k.id                    
      630 +        WHERE r.id = ?                                        
      631 +    ''', (rapport_id,)).fetchone()                            
      632 +                                                              
      633 +    if not row:                                               
      634 +        return "Rapport nicht gefunden", 404                  
      635 +                                                              
      636 +    # Konvertiere zu Dicts fÃ¼r einfacheren Zugriff            
      637 +    rapport = {                                               
      638 +        'id': row['id'],                                      
      639 +        'kunde_id': row['kunde_id'],                          
      640 +        'datum': row['datum'],                                
      641 +        'dauer_minuten': row['dauer_minuten'],                
      642 +        'thema': row['thema'],                                
      643 +        'kosten': row['kosten'],                              
      644 +        'bezahlt': row['bezahlt'],                            
      645 +        'zahlungsart': row['zahlungsart']                     
      646 +    }                                                         
      647 +    kunde = {                                                 
      648 +        'name': row['kunde_name'],                            
      649 +        'email': row['email'],                                
      650 +        'adresse': row['adresse'],  # Fallback fÃ¼r alte Daten 
      651 +        'strasse': row['strasse'],                            
      652 +        'hausnummer': row['hausnummer'],                      
      653 +        'plz': row['plz'],                                    
      654 +        'stadt': row['stadt']                                 
      655 +    }                                                         
      656 +                                                              
      657 +    # Validierung                                             
      658 +    if not PAYEE_CONFIG['iban']:                              
      659 +        return "Fehler: IBAN nicht konfiguriert. Bitte PAYEE_I
          +BAN in docker-compose.yml setzen.", 500                       
      660 +                                                              
      661 +    if not rapport['kosten'] or rapport['kosten'] <= 0:       
      662 +        return "Fehler: Rapport hat keinen gÃ¼ltigen Betrag.", 
          +400                                                           
      663 +                                                              
      664 +    # Generiere Rechnungsnummer                               
      665 +    rechnungs_nummer = generiere_rechnungsnummer()            
      666 +                                                              
      667 +    # Speichere Rechnung in DB                                
      668 +    db.execute(                                               
      669 +        'INSERT INTO rechnungen (rechnungs_nummer, kunde_id, b
          +etrag, rapport_ids) VALUES (?, ?, ?, ?)',                     
      670 +        (rechnungs_nummer, rapport['kunde_id'], rapport['koste
          +n'], str(rapport_id))                                         
      671 +    )                                                         
      672 +    db.commit()                                               
      673 +                                                              
      674 +    # Generiere PDF                                           
      675 +    try:                                                      
      676 +        pdf_bytes = erstelle_rechnung_pdf(rapport, kunde, rech
          +nungs_nummer)                                                 
      677 +    except Exception as e:                                    
      678 +        return f"Fehler beim Erstellen der Rechnung: {str(e)}"
          +, 500                                                         
      679 +                                                              
      680 +    # RÃ¼ckgabe als Download                                   
      681 +    response = make_response(pdf_bytes)                       
      682 +    response.headers['Content-Type'] = 'application/pdf'      
      683 +    response.headers['Content-Disposition'] = f'attachment; fi
          +lename=Rechnung_{rechnungs_nummer}.pdf'                       
      684 +                                                              
      685 +    return response                                           
      686 +                                                              
      687  @app.teardown_appcontext
      688  def close_connection(exception):
      689      """SchlieÃŸe Datenbankverbindung"""

â— Task #7: Kunden-Formulare anpassen

â— Read 1 file (ctrl+o to expand)

â— Update(app/templates/kunde_form.html)
  âŽ¿ Â Added 14 lines, removed 2 lines
      19              <input type="text" id="telefon" name="telefon" valu
          e="{{ kunde.telefon if kunde else '' }}">
      20          </div>
      21          <div class="form-group">
      22 -            <label for="adresse">Adresse</label>               
      23 -            <textarea id="adresse" name="adresse">{{ kunde.adre
         -sse if kunde else '' }}</textarea>                             
      22 +            <label for="strasse">Strasse</label>               
      23 +            <input type="text" id="strasse" name="strasse" valu
         +e="{{ kunde.strasse if kunde else '' }}">                      
      24          </div>
      25          <div class="form-group">
      26 +            <label for="hausnummer">Hausnummer</label>         
      27 +            <input type="text" id="hausnummer" name="hausnummer
         +" value="{{ kunde.hausnummer if kunde else '' }}" style="width:
         + 150px;">                                                      
      28 +        </div>                                                 
      29 +        <div class="form-group">                               
      30 +            <label for="plz">PLZ</label>                       
      31 +            <input type="text" id="plz" name="plz" value="{{ ku
         +nde.plz if kunde else '' }}" pattern="[0-9]{4}" title="4-stelli
         +ge Postleitzahl" style="width: 150px;">                        
      32 +        </div>                                                 
      33 +        <div class="form-group">                               
      34 +            <label for="stadt">Stadt</label>                   
      35 +            <input type="text" id="stadt" name="stadt" value="{
         +{ kunde.stadt if kunde else '' }}">                            
      36 +        </div>                                                 
      37 +        <div class="form-group">                               
      38              <label for="it_infrastruktur">IT-Infrastruktur (Mac
          OS, Linux, Windows, Drucker, etc.)</label>
      39              <textarea id="it_infrastruktur" name="it_infrastruk
          tur">{{ kunde.it_infrastruktur if kunde else '' }}</textarea>
      40          </div>

â— Jetzt passe ich die Routes in main.py an:

â— Searched for 1 pattern (ctrl+o to expand)

â— Update(app/main.py)
  âŽ¿ Â Added 5 lines, removed 4 lines
      303      if request.method == 'POST':
      304          db = get_db()
      305          db.execute(
      306 -            'INSERT INTO kunden (name, email, telefon, adresse
          -, it_infrastruktur, stundensatz) '                            
      307 -            'VALUES (?, ?, ?, ?, ?, ?)',                      
      306 +            'INSERT INTO kunden (name, email, telefon, strasse
          +, hausnummer, plz, stadt, it_infrastruktur, stundensatz) '    
      307 +            'VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)',             
      308              (request.form['name'], request.form['email'], requ
           est.form['telefon'],
      309 -             request.form['adresse'], request.form['it_infrast
          -ruktur'],                                                     
      310 -             request.form.get('stundensatz', 120.0))          
      309 +             request.form.get('strasse', ''), request.form.get
          +('hausnummer', ''),                                           
      310 +             request.form.get('plz', ''), request.form.get('st
          +adt', ''),                                                    
      311 +             request.form['it_infrastruktur'], request.form.ge
          +t('stundensatz', 120.0))                                      
      312          )
      313          db.commit()
      314          return redirect(url_for('kunden_liste'))

â— Searched for 2 patterns (ctrl+o to expand)

â— Update(app/main.py)
  âŽ¿ Â Added 6 lines, removed 5 lines
      389  def kunde_bearbeiten(kunde_id):
      390      """Kunde bearbeiten"""
      391      db = get_db()
      392 -                                                              
      392 +                                                              
      393      if request.method == 'POST':
      394          db.execute(
      395 -            'UPDATE kunden SET name=?, email=?, telefon=?, adr
          -esse=?, it_infrastruktur=?, stundensatz=? WHERE id=?',        
      395 +            'UPDATE kunden SET name=?, email=?, telefon=?, str
          +asse=?, hausnummer=?, plz=?, stadt=?, it_infrastruktur=?, stun
          +densatz=? WHERE id=?',                                        
      396              (request.form['name'], request.form['email'], requ
           est.form['telefon'],
      397 -             request.form['adresse'], request.form['it_infrast
          -ruktur'],                                                     
      398 -             request.form.get('stundensatz', 120.0), kunde_id)
      397 +             request.form.get('strasse', ''), request.form.get
          +('hausnummer', ''),                                           
      398 +             request.form.get('plz', ''), request.form.get('st
          +adt', ''),                                                    
      399 +             request.form['it_infrastruktur'], request.form.ge
          +t('stundensatz', 120.0), kunde_id)                            
      400          )
      401          db.commit()
      402          return redirect(url_for('kunde_detail', kunde_id=kunde
           _id))
      402 -                                                              
      403 +                                                              
      404      kunde = db.execute('SELECT * FROM kunden WHERE id = ?', (k
           unde_id,)).fetchone()
      405      return render_template('kunde_form.html', kunde=kunde, edi
           t_mode=True)
      406  

â— Task #8: UI-Integration: Rechnung-Buttons hinzufÃ¼gen

â— Read 1 file (ctrl+o to expand)

â— Update(app/templates/index.html)
  âŽ¿ Â Added 1 line
      58                  <th>Kosten</th>
      59                  <th>Status</th>
      60                  <th>Aktion</th>
      61 +                <th>Rechnung</th>                              
      62              </tr>
      63          </thead>
      64          <tbody>

â— Update(app/templates/index.html)
  âŽ¿ Â Added 5 lines
      79                  <td>
      80                      <a href="/rapporte/{{ rapport.id }}/bearbei
          ten" style="text-decoration: none;">âœï¸</a>
      81                  </td>
      82 +                <td>                                           
      83 +                    <a href="/rechnung/rapport/{{ rapport.id }}
         +" class="btn" style="font-size: 0.9em; padding: 0.3em 0.6em;"> 
      84 +                        ðŸ“„ Rechnung                            
      85 +                    </a>                                       
      86 +                </td>                                          
      87              </tr>
      88              {% endfor %}
      89          </tbody>

â— Task #9: docker-compose.yml Environment-Variablen dokumentieren

â— Read 1 file (ctrl+o to expand)

â— Update(docker-compose.yml)
  âŽ¿ Â Added 10 lines
      11        - DATABASE_PATH=/app/data/rapporte.db
      12        - AUTH_USERNAME=admin
      13        - AUTH_PASSWORD_HASH=scrypt:32768:8:1$1ZbWMCGxr3LojhYP$3c
          c2935de4a34892a957b8c5a1a884e0198f5a75da822e4cce95fccfcdcbd8638
          bf0850030663577249b5756eb641c1cf69e18abee389f46a868181b32e9c179
      14 +      # QR-Rechnungs-Konfiguration (fÃ¼r Swiss QR Bill)         
      15 +      # WICHTIG: Ersetzen Sie die Platzhalter mit Ihren echten 
         +Daten!                                                         
      16 +      # - PAYEE_LEGAL_NAME=Ihr Name oder Firmenname            
      17 +      # - PAYEE_IBAN=CH5800791123000889012                     
      18 +      # - PAYEE_BANK=Name der Bank                             
      19 +      # - PAYEE_BIC=POFICHBEXXX                                
      20 +      # - PAYEE_DISPLAY_NAME=Ihr Anzeigename                   
      21 +      # - PAYEE_ADDRESS_LINE1=Strasse und Hausnummer           
      22 +      # - PAYEE_ADDRESS_LINE2=PLZ und Ort                      
      23 +      # - PAYEE_COUNTRY=CH                                     
      24      restart: unless-stopped
      25      networks:
      26        - dieti-it_app

â— Perfekt! Alle Tasks sind abgeschlossen. Lassen Sie mich noch eine README fÃ¼r
  die Implementierung erstellen:

â— Write(QR_RECHNUNG_README.md)
  âŽ¿ Â Wrote 152 lines to QR_RECHNUNG_README.md
       1 # Swiss QR Bill Rechnungsfunktion - Implementierung
       2 
       3 ## âœ… Implementierte Features
       4 
       5 Die Swiss QR Bill Rechnungsfunktion wurde erfolgreich implementi
         ert:
       6 
       7 1. âœ… **Dependencies hinzugefÃ¼gt** (`qrbill==1.2.0`, `svglib==1.
         5.1`)
       8 2. âœ… **Datenbank-Schema erweitert**:
       9    - Kunden-Tabelle: Separate Adressfelder (strasse, hausnummer,
          plz, stadt)
      10    - Neue `rechnungen` Tabelle fÃ¼r Rechnungs-Tracking
     â€¦ +142 lines (ctrl+o to expand)

â— Perfekt! Lassen Sie mich nun eine Zusammenfassung erstellen:

  âœ… Implementierung abgeschlossen!

  Die Swiss QR Bill Rechnungsfunktion wurde erfolgreich implementiert. Hier ist
  eine Zusammenfassung der durchgefÃ¼hrten Ã„nderungen:

  ðŸ“¦ Implementierte Features

  1. Dependencies hinzugefÃ¼gt (requirements.txt:5-6)
    - qrbill==1.2.0 fÃ¼r Swiss QR Bill Generierung
    - svglib==1.5.1 fÃ¼r SVG-zu-PDF Konvertierung
  2. Datenbank-Schema erweitert (app/database.py:18-75)
    - Kunden-Tabelle: Neue Felder strasse, hausnummer, plz, stadt
    - Neue rechnungen Tabelle fÃ¼r Rechnungs-Tracking mit eindeutiger
  Rechnungsnummer
  3. Migrations-Script erstellt (migrate_adressen.py)
    - Automatisches Parsen bestehender Adressen in separate Felder
    - Regex-basierte Extraktion von Strasse, Hausnummer, PLZ, Stadt
  4. QR-Bill Kern-FunktionalitÃ¤t (app/main.py:52-234)
    - generiere_rechnungsnummer(): RE-YYYYMMDD-XXXXX Format
    - generiere_qr_rechnung(): Swiss QR Bill mit Creditor/Debtor
    - erstelle_rechnung_pdf(): VollstÃ¤ndige Rechnung mit QR-Code
  5. Neue Route (app/main.py:617-693)
    - /rechnung/rapport/<id> fÃ¼r Einzel-Rapport-Rechnungen
    - Validierung, DB-Tracking, PDF-Download
  6. UI-Integration
    - kunde_form.html:21-30: Separate Adressfelder im Kundenformular
    - index.html:60,78-82: "ðŸ“„ Rechnung" Button bei jedem Rapport
  7. Backend-Anpassungen (app/main.py:299-404)
    - kunde_neu() und kunde_bearbeiten() fÃ¼r neue Adressfelder
  8. Dokumentation
    - docker-compose.yml:14-22: Kommentierte PAYEE_* Environment-Variablen
    - QR_RECHNUNG_README.md: VollstÃ¤ndige Anleitung fÃ¼r Setup und Testing

  ðŸš€ NÃ¤chste Schritte

  Vor dem ersten Deployment:

  1. Dependencies installieren:
  pip install -r requirements.txt
  2. Falls bestehende Kundendaten vorhanden: Migration ausfÃ¼hren:
  python3 migrate_adressen.py
  3. Environment-Variablen konfigurieren in docker-compose.yml:
    - PAYEE_LEGAL_NAME (Ihr Name/Firma)
    - PAYEE_IBAN (Ihre QR-IBAN!)
    - PAYEE_BANK, PAYEE_BIC
    - PAYEE_DISPLAY_NAME
    - PAYEE_ADDRESS_LINE1 (Strasse und Hausnummer)
    - PAYEE_ADDRESS_LINE2 (PLZ und Ort)
  4. Container neu bauen:
  docker-compose down
  docker-compose up --build -d
  5. Testen:
    - Rapport mit Kosten > 0 auswÃ¤hlen
    - "ðŸ“„ Rechnung" Button klicken
    - PDF herunterladen
    - QR-Code mit Banking-App scannen

  ðŸ“‹ Wichtige Hinweise

  - QR-IBAN erforderlich: Normale IBANs funktionieren nicht fÃ¼r QR-Rechnungen
  - Das alte adresse-Feld bleibt als Fallback fÃ¼r bestehende Daten
  - Rechnungsnummern sind eindeutig und werden automatisch sequenziert
  - Bei fehlendem QR-Code wird eine Fehlermeldung im PDF angezeigt
  - Das thema-Feld des Rapports wird als Beschreibung auf der Rechnung verwendet

  Alle Details finden Sie in der Datei QR_RECHNUNG_README.md! ðŸŽ‰

âœ» Cooked for 4m 34s

â¯ super. danke, ich habe inzwischen docker hier lokal auf dem eos           
  installiert. die prod-daten sind auf dem raspberry "server". dh ich       
  mÃ¼sste die db auf dem prod server extrahieren/backup erstellen und hier   
  auf dem eos dev importieren. kannst du mich bitte anleiten ?              

â— Sehr gerne! Ich leite Sie durch den Prozess, die Produktions-Datenbank vom
  Raspberry Pi auf Ihren lokalen EOS Dev-Rechner zu Ã¼bertragen.

  ðŸ“‹ Datenbank-Backup & Import-Anleitung

  Schritt 1: Backup auf dem Raspberry Pi erstellen

  SSH-Verbindung zum Raspberry Pi herstellen und Backup erstellen:

  # SSH zum Raspberry Pi
  ssh pi@<raspberry-ip>  # oder dietipi@... - je nach Setup

  # Navigiere zum Rapporte-Verzeichnis
  cd ~/rapporte  # oder wo auch immer Ihr docker-compose.yml liegt

  # Erstelle Backup mit Zeitstempel
  docker exec rapporte-rapporte-app-1 cat /app/data/rapporte.db >
  rapporte_backup_$(date +%Y%m%d_%H%M%S).db

  # ODER falls Container anders heiÃŸt, erst Namen finden:
  docker ps | grep rapporte
  # Dann mit korrektem Container-Namen:
  docker exec <container-name> cat /app/data/rapporte.db >
  rapporte_backup_$(date +%Y%m%d_%H%M%S).db

  # Backup verifizieren
  ls -lh rapporte_backup_*.db

  Schritt 2: Backup vom Raspberry zum EOS kopieren

  Auf Ihrem EOS Dev-Rechner (neues Terminal):

  # Navigiere zu Ihrem lokalen Rapporte-Verzeichnis
  cd ~/dev/Rapporte

  # Erstelle data-Verzeichnis falls nicht vorhanden
  mkdir -p data

  # Kopiere Backup vom Raspberry Pi
  scp pi@<raspberry-ip>:~/rapporte/rapporte_backup_*.db ./data/rapporte.db

  # ODER mit spezifischem Zeitstempel:
  scp pi@<raspberry-ip>:~/rapporte/rapporte_backup_20260203_143022.db
  ./data/rapporte.db

  # Backup verifizieren
  ls -lh data/rapporte.db
  sqlite3 data/rapporte.db "SELECT COUNT(*) FROM kunden;"

  Schritt 3: Migration durchfÃ¼hren (Adressen aufteilen)

  Wichtig: Erst Migration, dann Docker starten!

  # Noch im Rapporte-Verzeichnis auf EOS
  # Erstelle lokales Backup (Sicherheitskopie)
  cp data/rapporte.db data/rapporte_vor_migration_$(date +%Y%m%d_%H%M%S).db

  # Migration ausfÃ¼hren
  python3 migrate_adressen.py

  # Migrierte Daten prÃ¼fen
  sqlite3 data/rapporte.db "SELECT id, name, strasse, hausnummer, plz, stadt 
  FROM kunden LIMIT 5;"

  Schritt 4: Lokale Docker-Umgebung starten

  # Dependencies installieren (falls noch nicht geschehen)
  pip install -r requirements.txt

  # Docker Container bauen und starten
  docker-compose up --build -d

  # Logs prÃ¼fen
  docker-compose logs -f

  # App Ã¶ffnen (in anderem Terminal oder Browser)
  open http://localhost:8085
  # oder
  firefox http://localhost:8085

  Schritt 5: Testen

  # Login mit admin/changeme (oder Ihrem konfigurierten Passwort)
  # PrÃ¼fen Sie:
  # 1. Kundenliste vollstÃ¤ndig?
  # 2. Rapporte vorhanden?
  # 3. Login-Daten sichtbar?

  ðŸ”§ Alternative: Direkte SCP-Kopie mit spezifischem Pfad

  Falls der Container-Name schwierig ist:

  Auf dem Raspberry Pi:
  # Finde den exakten Pfad
  docker inspect rapporte-rapporte-app-1 | grep -A 5 "Mounts"
  # ODER
  docker volume ls
  docker volume inspect <volume-name>

  # Kopiere direkt vom Volume-Pfad (meist /var/lib/docker/volumes/...)
  # ABER einfacher: Ã¼ber docker exec wie oben

  ðŸš¨ Troubleshooting

  Problem: Container-Name nicht gefunden

  # Auf Raspberry Pi:
  docker ps -a | grep rapporte
  # Nutze den exakten Namen aus der Ausgabe

  Problem: Permission denied beim SCP

  # Auf Raspberry Pi: Backup in Home-Verzeichnis kopieren
  docker exec rapporte-rapporte-app-1 cat /app/data/rapporte.db >
  ~/rapporte_backup.db
  chmod 644 ~/rapporte_backup.db

  # Dann von EOS:
  scp pi@<raspberry-ip>:~/rapporte_backup.db ./data/rapporte.db

  Problem: Migration-Script findet Datenbank nicht

  # Pfad in migrate_adressen.py anpassen oder als Parameter Ã¼bergeben:
  python3 migrate_adressen.py
  # Das Script nutzt bereits 'data/rapporte.db' als Default

  Problem: Docker Port 8085 bereits belegt

  # Port in docker-compose.yml Ã¤ndern:
  # ports:
  #   - "8086:8085"  # oder anderen freien Port

  ðŸ“Š Daten-Synchronisation-Workflow

  FÃ¼r zukÃ¼nftige Updates:

  # 1. Backup auf Raspberry erstellen
  ssh pi@<raspberry-ip> "docker exec rapporte-rapporte-app-1 cat 
  /app/data/rapporte.db" > ./data/rapporte_sync_$(date +%Y%m%d_%H%M%S).db

  # 2. Aktuelles lokales Backup erstellen
  cp data/rapporte.db data/rapporte_backup_before_sync_$(date +%Y%m%d_%H%M%S).db

  # 3. Neue Daten kopieren
  cp data/rapporte_sync_*.db data/rapporte.db

  # 4. Container neu starten
  docker-compose restart

  MÃ¶chten Sie, dass ich Ihnen beim Verbindungsaufbau zum Raspberry Pi helfe,
  oder haben Sie eine spezielle Netzwerk-Konfiguration?

âœ» Brewed for 35s